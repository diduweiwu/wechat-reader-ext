<template>
  <el-popover placement="left" :width="330" title="é˜…è¯»é…ç½®">
    <template #reference>
      <el-button
        :style="{ opacity: config.isScrolling ? 0.5 : 1 }"
        type="default"
        class="config-button"
        plain
        circle
      >è¯»
      </el-button>
    </template>
    <el-card shadow="hover">
      <el-form ref="form" :model="config" label-width="100px" size="mini">
        <el-form-item label="æ»šå±é˜…è¯»">
          <el-radio-group v-model="config.isScrolling" size="mini">
            <el-radio border :label="true">å¼€å¯</el-radio>
            <el-radio border :label="false">å…³é—­</el-radio>
          </el-radio-group>
        </el-form-item>
        <el-form-item label="æ»šåŠ¨æ­¥é•¿">
          <el-input
            :disabled="config.isScrolling"
            v-model="config.scrollOffset"
            min="1"
            max="200"
            type="number"
            maxlength="3"
          >
            <template #suffix>
              <i>åƒç´ </i>
            </template>
          </el-input>
        </el-form-item>
        <el-form-item label="æ»šåŠ¨é—´éš”">
          <el-input
            :disabled="config.isScrolling"
            v-model="config.timerScrollIMs"
            min="200"
            max="90000"
            maxlength="5"
          >
            <template #suffix><i>æ¯«ç§’</i></template>
          </el-input>
        </el-form-item>
        <el-form-item label="æ»šåŠ¨æ–¹å‘">
          <el-radio-group
            :disabled="config.isScrolling"
            v-model="config.scrollFlag"
          >
            <el-radio border :label="1">æ­£å‘</el-radio>
            <el-radio border :label="-1">åå‘</el-radio>
          </el-radio-group>
        </el-form-item>
        <el-form-item label="è‡ªåŠ¨ç¿»é¡µ">
          <el-radio-group
            :disabled="config.isScrolling"
            v-model="config.isAutoSwitchPage"
          >
            <el-radio border :label="true">å¼€å¯</el-radio>
            <el-radio border :label="false">å…³é—­</el-radio>
          </el-radio-group>
        </el-form-item>
        <el-form-item label="ç¿»é¡µæ–¹å‘">
          <el-radio-group
            v-model="config.autoSwitchPageFlag"
            :disabled="config.isScrolling || !config.isAutoSwitchPage"
          >
            <el-radio border :label="1">æ­£å‘</el-radio>
            <el-radio border :label="-1">åå‘</el-radio>
          </el-radio-group>
        </el-form-item>

        <el-form-item label="é˜…è¯»å®½åº¦">
          <el-input
            v-model="config.readContentWidth"
            type="number"
            :max="20000"
            :min="100"
          >
            <template #suffix><i>åƒç´ </i></template>
          </el-input>
        </el-form-item>

        <el-divider direction="horizontal" content-position="center"
        >å…¶ä»–
        </el-divider
        >
        <el-form-item>
          <template #label>
            <el-tooltip placement="left">
              <div slot="content">
                å¼€å¯è‡ªåŠ¨åˆ·æ—¶é•¿æ¨¡å¼åï¼Œå¯å°†é¡µé¢æ”¾åˆ°åå° <br>
                ä¼šé—´éš”ä¸€å®šæ—¶é—´åˆ·æ–°é¡µé¢ï¼Œé¿å…è¢«å¾®ä¿¡è¯»ä¹¦æ£€æµ‹å¯¼è‡´æš‚åœæ—¶é•¿ç´¯ç§¯ <br>
                å¦‚æœæ‚¨ä¸€ç›´åœ¨å‰ç«¯é˜…è¯»ï¼Œåˆ™å¯ä»¥å…³é—­è¯¥é¡¹é¿å…å½±å“é˜…è¯»ä½“éªŒ
              </div>
              <span><i class="el-icon-info"/> è‡ªåŠ¨æ—¶é•¿</span>
            </el-tooltip>
          </template>
          <el-radio-group
            v-model="config.timeFlashMode"
          >
            <el-radio border :label="true">å¼€å¯</el-radio>
            <el-radio border :label="false">å…³é—­</el-radio>
          </el-radio-group>
        </el-form-item>
        <el-form-item label="å·¥å…·æ ">
          <el-radio-group v-model="config.isHideControls">
            <el-radio border :label="true">æ˜¾ç¤º</el-radio>
            <el-radio border :label="false">éšè—</el-radio>
          </el-radio-group>
        </el-form-item>

      </el-form>
      <el-divider>æˆ‘çš„è´¦æˆ·</el-divider>
      <el-row :gutter="10">
        <el-col :span="12">
          <el-card shadow="hover">
            <span>å®‰å“ä¹¦å¸</span>
            <br><strong class="gray">{{ me.androidBookCoin }} ä¸ª</strong>
          </el-card>
        </el-col>
        <el-col :span="12">
          <el-card shadow="hover">
            <span>è‹¹æœä¹¦å¸</span>
            <br><strong class="gray">{{ me.iosBookCoin }} ä¸ª</strong>
          </el-card>
        </el-col>
        <el-col :span="12">
          <el-card shadow="hover">
            <span>æ— é™å¡</span>
            <br><strong class="gray">{{ me.infiniteCardDays }} å¤©</strong>
          </el-card>
        </el-col>
        <el-col :span="12">
          <el-card shadow="hover">
            <span>æºç åœ°å€</span>
            <br><strong class="gray"><a href="https://gitee.com/diduweiwu-itestdev/wechat-reader-ext" target="_blank">ç‚¹å‡»ç›´è¾¾ğŸ§</a></strong>
          </el-card>
        </el-col>
      </el-row>
    </el-card>
  </el-popover>
</template>

<script>
import axios from "axios";

export default {
  name: "wechatReaderExt",
  data: () => ({
    config: {
      isScrolling: false,

      // æ»šåŠ¨æ–¹å‘æ ‡è®° 1 æ­£å‘ï¼Œå¾€ä¸‹ -1 åå‘ï¼Œå¾€ä¸Š
      scrollFlag: 1,
      // è‡ªåŠ¨æ»šåŠ¨æ­¥é•¿
      scrollOffset: 1,
      // è‡ªåŠ¨æ»šåŠ¨æ—¶é—´é—´éš”ï¼ˆæ¯«ç§’ï¼‰
      timerScrollIMs: 200,

      // æ˜¯å¦è‡ªåŠ¨ç¿»é¡µ
      isAutoSwitchPage: false,
      // è‡ªåŠ¨ç¿»é¡µæ–¹å‘
      autoSwitchPageFlag: 1,

      // content width é˜…è¯»åŒºåŸŸå®½åº¦
      readContentWidth: 1000,

      // éšè—å·¥å…·æ 
      isHideControls: false,
      // é¢æ¿é…ç½®å±•ç¤ºé¡¹
      panelItem: "1",

      // time flash mode
      timeFlashMode: false,
    },
    timerScroll: null,
    timerTurnPage: null,
    timeFlash: null,

    me: {
      // æ— é™å¡å¤©æ•°
      infiniteCardDays: 0,
      // iosç«¯ä¹¦å¸
      iosBookCoin: 0,
      // å®‰å“ç«¯ä¹¦å¸
      androidBookCoin: 0,
    },
  }),
  methods: {
    // è®¡ç®—ç¿»é¡µæ–¹å‘ -1å¾€å‰ç¿» 1 å¾€åç¿»
    computeSwitchPageFlag() {
      const isLast =
        document.getElementsByClassName("readerFooter_button").length === 0;
      const isFirst =
        document.getElementsByClassName("readerBookInfo").length === 1;
      // å½“å‰æ˜¯æ­£å‘ï¼Œå¹¶ä¸”å·²ç»åˆ°è¾¾æœ€åä¸€é¡µï¼Œåˆ™åˆ‡æ¢åˆ°åå‘
      if (this.config.autoSwitchPageFlag === 1 && isLast) {
        return -1;
      }

      // å½“å‰æ˜¯é€†å‘ï¼Œå¹¶ä¸”å·²ç»åˆ°åº•ç¬¬ä¸€é¡µï¼Œåˆ™åˆ‡æ¢åˆ°åå‘
      if (this.config.autoSwitchPageFlag === -1 && isFirst) {
        return 1;
      }

      return this.config.autoSwitchPageFlag;
    },
    // è®¡ç®—æ»‘åŠ¨æ–¹å‘ -1å¾€ä¸Šæ»‘åŠ¨ 1å¾€ä¸‹æ»‘åŠ¨
    computeScrollFlag() {
      const {scrollTop, clientHeight, scrollHeight} =
        document.documentElement;
      // å·²ç»æ»šåŠ¨åˆ°åº•éƒ¨ï¼Œåˆ‡æ¢ä¸ºå¾€ä¸Šæ»šåŠ¨
      if (scrollTop + clientHeight >= scrollHeight) {
        this.config.scrollFlag = -1;
      }

      // å·²ç»æ»šåŠ¨åˆ°é¡¶éƒ¨ï¼Œåˆ‡æ¢ä¸ºå¾€ä¸‹æ»šåŠ¨
      if (scrollTop === 0) {
        this.config.scrollFlag = 1;
      }
    },
    start() {
      if (this.timerScroll == null) {
        const _this = this;
        this.timerScroll = setInterval(function () {
          let scrollYOffset =
            window.pageYOffset +
            _this.config.scrollFlag * _this.config.scrollOffset;
          // æ¨¡æ‹Ÿæ»šåŠ¨
          window.scrollTo(0, scrollYOffset);
          _this.computeScrollFlag();
        }, _this.config.timerScrollIMs);
      }
    },
    stop() {
      // æ¸…é™¤è‡ªåŠ¨æ»šå±è®¡æ—¶å™¨
      const timerScroll = this.timerScroll;
      if (timerScroll != null) {
        clearInterval(timerScroll);
        this.timerScroll = null;
      }
    },
    fireKeyEvent(el, evtType, keyCode) {
      let evtObj;
      if (document.createEvent) {
        // firefox æµè§ˆå™¨ä¸‹æ¨¡æ‹Ÿäº‹ä»¶
        if (window.KeyEvent) {
          evtObj = document.createEvent("KeyEvents");
          evtObj.initKeyEvent(evtType, true, true);
          el.dispatchEvent(evtObj);
          return;
        }

        // chrome æµè§ˆå™¨ä¸‹æ¨¡æ‹Ÿäº‹ä»¶
        evtObj = document.createEvent("UIEvents");
        evtObj.initUIEvent(evtType, true, true);

        delete evtObj.keyCode;
        //ä¸ºäº†æ¨¡æ‹Ÿkeycode
        if (typeof evtObj.keyCode === "undefined") {
          Object.defineProperty(evtObj, "keyCode", {value: keyCode});
        } else {
          evtObj.key = String.fromCharCode(keyCode);
        }

        if (typeof evtObj.ctrlKey === "undefined") {
          //ä¸ºäº†æ¨¡æ‹Ÿctrlé”®
          Object.defineProperty(evtObj, "ctrlKey", {value: true});
        } else {
          evtObj.ctrlKey = true;
        }

        el.dispatchEvent(evtObj);
        return;
      }

      //IE æµè§ˆå™¨ä¸‹æ¨¡æ‹Ÿäº‹ä»¶
      if (document.createEventObject) {
        evtObj = document.createEventObject();
        evtObj.keyCode = keyCode;
        el.fireEvent("on" + evtType, evtObj);
      }
    },
    switchToNextPage() {
      // è·å–ç¿»é¡µæ–¹å‘æ ‡è¯†å€¼,æœ‰ä¸‹ä¸€é¡µæŒ‰é’®åˆ™ä¸ºæ­£å‘ç¿»é¡µï¼Œæ²¡æœ‰çš„è¯åˆ™åå‘ç¿»é¡µ
      this.config.autoSwitchPageFlag = this.computeSwitchPageFlag();
      // 37ä¸ºå·¦ç¿»é¡µï¼Œ39ä¸ºå³ç¿»é¡µ
      let keyEventCode = this.config.autoSwitchPageFlag === -1 ? 37 : 39;

      // æ­¤æ—¶è¿™é‡Œåº”è¯¥åˆ¤æ–­æ˜¯å¦ä¸ºç¬¬ä¸€ç« /æœ€ç»ˆç« ,æ–¹ä¾¿å¾€å›çœ‹,å½¢æˆé˜…è¯»é—­ç¯
      this.fireKeyEvent(document, "keydown", keyEventCode);
    },
    loadConfig() {
      const configJson = localStorage.getItem("config");
      if (!configJson) {
        return;
      }
      try {
        const config = JSON.parse(configJson);
        Object.assign(this.config, config);
      } catch (e) {
        console.log("è§£æé…ç½®å‡ºé”™ï¼Œä½¿ç”¨é»˜è®¤é…ç½®");
      }
    },
    // æ›´æ”¹å†…å®¹åŒºåŸŸå®½åº¦
    resizeWidth(newWidth) {
      document.querySelector(".readerContent .app_content").style["max-width"] =
        newWidth + "px";
      document.querySelector(".readerTopBar").style["max-width"] =
        newWidth + "px";
      const myEvent = new Event("resize");
      window.dispatchEvent(myEvent);
    },
    // load member info
    loadMemberInfo() {
      const balanceCallback = res => {
        const {giftBalance: iosBookCoin, peerBalance: androidBookCoin, welfare} = res.data
        const {expiredTime} = welfare
        const infiniteCardDays = Math.floor(expiredTime / 3600 / 24)
        Object.assign(this.me, {iosBookCoin, androidBookCoin, infiniteCardDays})
      }
      axios.post(`/web/pay/balance`, {
        "zoneid": "1",
        "release": "1",
        "pf": "weread_wx-2001-iap-2001-iphone"
      }).then(balanceCallback)
    }
  },
  watch: {
    "config.isScrolling"(newValue, oldValue) {
      if (newValue === true) {
        this.start();
      }

      if (newValue === false) {
        this.stop();
      }
    },
    "config.scrollFlag": {
      handler: function (newValue, oldValue) {
        // åªæœ‰åœ¨æ­£å‘æ»šåŠ¨ï¼Œå¹¶ä¸”åˆ°è¾¾åº•éƒ¨æ—¶å€™ï¼Œæ‰è¿›è¡Œç¿»é¡µ
        if (
          this.config.isScrolling &&
          oldValue === 1 &&
          this.config.isAutoSwitchPage
        ) {
          this.switchToNextPage();
        }
      },
      deep: true,
    },
    "config.readContentWidth": {
      handler: function (newValue, oldValue) {
        // åªæœ‰åœ¨æ­£å‘æ»šåŠ¨ï¼Œå¹¶ä¸”åˆ°è¾¾åº•éƒ¨æ—¶å€™ï¼Œæ‰è¿›è¡Œç¿»é¡µ
        this.resizeWidth(newValue);
      },
      deep: true,
    },
    "config.isHideControls": {
      handler: function (newValue, oldValue) {
        // åªæœ‰åœ¨æ­£å‘æ»šåŠ¨ï¼Œå¹¶ä¸”åˆ°è¾¾åº•éƒ¨æ—¶å€™ï¼Œæ‰è¿›è¡Œç¿»é¡µ
        document.querySelector(".readerControls").style.opacity = newValue
          ? 1
          : 0;
      },
      deep: true,
      immediate: true,
    },
    "config.timeFlashMode"(newValue, oldValue) {
      if (newValue === true) {
        if (this.timeFlash === null) {
          // 70ç§’è‡ªåŠ¨ä¸‹ä¸€é¡µé¿å…è¢«åˆ¤å®šä¸ºåå°
          setInterval(this.switchToNextPage, 70000)
          return false
        }
      }

      if (newValue === false) {
        if (this.timeFlash !== null) {
          clearInterval(this.timeFlash)
          this.timeFlash = null
        }
      }

    },
    config: {
      handler: function () {
        localStorage.setItem("config", JSON.stringify(this.config));
      },
      deep: true,
    },
  },
  mounted() {
    this.loadConfig();
    this.loadMemberInfo()
  },
};
</script>

<style scoped>
.config-button {
  position: fixed;
  top: calc(100vh / 2);
  right: 10px;
}

.el-col {
  margin-bottom: 5px;
}

.gray {
  color: #928b8b;
}
</style>
